#!/usr/bin/env node

var CLI = require('./../lib/cli')
  , pkg = require('./../package.json')
  , ArgParse = require('argparse').ArgumentParser
  , os = require('os')
  , osenv = require('osenv')
  , crypto = require('crypto')
  , path = require('path')
  , chalk = require('chalk');

/*
 * Create argument parser.
 */

var parser = new ArgParse({
  version: pkg.version,
  description: pkg.description,
  addHelp: true
});

/*
 * Create argument subparser.
 */

var subParser = parser.addSubparsers({
  title: 'Actions',
  dest: 'action'
});

/*
 * $ sprout add
 */

var add = subParser.addParser('add', { aliases: ['install'], addHelp: true });
add.addArgument(['name'], { help: 'name of template' });
add.addArgument(['src'], { help: 'source path or remote git' });

/*
 * $ sprout remove
 */

var remove = subParser.addParser('remove', { aliases: ['delete'], addHelp: true });
remove.addArgument(['name'], { help: 'name of template' });

/*
 * $ sprout list
 */

var list = subParser.addParser('list', { aliases: ['ls', 'all'], addHelp: false });

/*
 * $ sprout init
 */

var init = subParser.addParser('init', { aliases: ['new', 'create'], addHelp: true });
init.addArgument(['name'], { help: 'name of template' });
init.addArgument(['target'], { help: 'destination path' });
init.addArgument(['-l', '--locals'], { nargs: '*', help: 'locals' });
init.addArgument(['-t', '--tag'], { help: 'git tag' });
init.addArgument(['-b', '--branch'], { help: 'git branch' });

/* A helper function for determining a Sprout path.
 * @returns {String} - a path for Sprout.
 */

var userSproutPath = function () {
  var user = (osenv.user() || generateFakeUser()).replace(/\\/g, '-')
    , tmp = path.join((os.tmpdir ? os.tmpdir() : ostmpDir()), user);
  return path.join((osenv.home() || tmp), '.config', 'sprout');
}

/*
 * A helper function for generating a fake
 * user; where necessary, used to create a
 * user Sprout path.
 * @returns {String} - a fake user string.
 */

var generateFakeUser = function () {
  var uid = [process.pid, Date.now(), Math.floor(Math.random()*10000000)].join('-');
  return crypto
    .createHash('md5')
    .update(uid)
    .digest('hex');
}

/*
 * Initialize CLI interface and
 * event handlers.
 */

var cli = new CLI(process.env.SPROUT_PATH ? process.env.SPROUT_PATH : userSproutPath())
  , emitter = cli.emitter;

emitter.on('success',
  function (message) {
    console.log(chalk.green('✓ ' + message.toString()));
  }
)

emitter.on('error',
  function (error) {
    console.error(chalk.red('✘ ' + error.toString()));
  }
)

emitter.on('list',
  function (list) {
    var item;
    for (var i=0; i<list.length; i++) {
      item = list[i];
      console.log(chalk.grey('- ' + item.toString()));
    }
  }
)

/*
 * Run CLI with arguments.
 */

cli.run(parser.parseArgs()).catch(
  function () {
    process.exit(1);
  }
);
